<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lumos ‚Äî –ü–æ–∏—Å–∫</title>
  <meta name="description" content="Lumos ‚Äî –ø–æ–∏—Å–∫ –ø–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ –º–∏–Ω–∏-—Å–∞–π—Ç–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" />
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{
      --bg:#ffffff; --accent:#ffd428; --muted:#6b7280; --card:#fff;
      --maxw:980px; font-family:Inter, Roboto, Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#111827;-webkit-font-smoothing:antialiased}
    .page{min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:28px;box-sizing:border-box}
    .wrap{width:100%;max-width:var(--maxw)}
    /* header / animated lift */
    header.top{display:flex;flex-direction:column;align-items:center;gap:8px;transform:translateY(8vh);transition:transform .42s cubic-bezier(.2,.9,.2,1),padding .25s}
    header.top.lift{transform:translateY(0);align-items:flex-start}
    @media(max-width:920px){ header.top{transform:translateY(6vh)} header.top.lift{align-items:center} }
    .logo{width:82px;height:82px;border-radius:18px;background:linear-gradient(135deg,#fff6d6,#ffe78e);display:flex;align-items:center;justify-content:center;font-size:40px;box-shadow:0 10px 30px rgba(0,0,0,0.06)}
    h1{margin:0;font-size:22px}
    p.lead{margin:0;color:var(--muted);font-size:14px}
    /* search */
    .search-wrap{margin-top:18px;display:flex;justify-content:center}
    .search-card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 8px 30px rgba(2,6,23,0.04);width:100%}
    .search-row{display:flex;gap:8px;align-items:center}
    input#q{flex:1;padding:14px 12px;border-radius:10px;border:1px solid #e8e9eb;font-size:16px;outline:none}
    button#go{background:var(--accent);border:0;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 8px 18px rgba(255,212,40,0.12)}
    /* layout */
    .main{display:flex;gap:18px;margin-top:18px}
    .left{flex:1}
    .right{width:360px}
    @media(max-width:920px){ .main{flex-direction:column} .right{width:100%} }
    /* results */
    .results{display:flex;flex-direction:column;gap:12px}
    .result{padding:14px;border-radius:8px;background:#fff;border:1px solid #eef0f2;display:flex;gap:12px;align-items:flex-start;opacity:0;transform:translateY(6px);animation:fadeIn .28s forwards}
    @keyframes fadeIn { to {opacity:1; transform:none} }
    .favicon{width:48px;height:48px;border-radius:8px;flex:0 0 48px;background:#fafafa;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .res-body{flex:1}
    .res-title{font-size:15px;font-weight:700;color:#1a202c;margin-bottom:6px}
    .res-url{font-size:13px;color:#0456a6;margin-bottom:6px;word-break:break-all}
    .res-snippet{font-size:14px;color:var(--muted)}
    .res-actions{margin-top:8px}
    .link-btn{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid #eef0f2;color:var(--muted);text-decoration:none;font-size:13px;margin-right:8px}
    /* viewer */
    .viewer{margin-top:12px;border:1px solid #e9eef2;border-radius:10px;overflow:hidden}
    .viewer iframe{width:100%;height:420px;border:0}
    /* small */
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">
      <header id="header" class="top">
        <div class="logo">üçã</div>
        <h1>Lumos</h1>
        <p class="lead">–ü–æ–∏—Å–∫ –ø–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ –º–∏–Ω–∏-—Å–∞–π—Ç–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
      </header>

      <div class="search-wrap">
        <div class="search-card" role="search">
          <div class="search-row">
            <input id="q" placeholder="–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏? –ü—Ä–∏–º–µ—Ä: –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–æ–ª–Ω—Ü–µ" autocomplete="off" />
            <button id="go">–ü–æ–∏—Å–∫</button>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div id="status" class="muted">–ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É</div>
            <div class="muted">–ú—ã —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ–º —Å DuckDuckGo</div>
          </div>
        </div>
      </div>

      <div class="main" style="width:100%">
        <div class="left">
          <div id="results" class="results">
            <div class="muted">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∏—Å–∫¬ª. Lumos —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç –ø–æ —Å–≤–æ–∏–º –º–∏–Ω–∏-—Å–∞–π—Ç–∞–º, –∑–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –∏ –≤–Ω–µ—à–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.</div>
          </div>

          <div id="viewer" class="viewer" style="display:none;margin-top:12px">
            <iframe id="frame" sandbox="allow-scripts allow-forms allow-modals"></iframe>
          </div>
        </div>

        <aside class="right">
          <div style="padding:12px;border-radius:10px;border:1px solid #eef0f2;background:#fff">
            <div style="font-weight:700">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Lumos</div>
            <div class="muted" style="margin-top:8px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç –º–∏–Ω–∏-—Å–∞–π—Ç—ã —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å. –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.</div>
            <div style="margin-top:12px"><a id="extDuck" class="link-btn" href="#" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –≤ DuckDuckGo</a></div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- ========== Firebase + search logic ========== -->
  <script type="module">
  /************************************************************************
   * Lumos: improved search UI
   * - internal search (Firestore) ‚Äî matches by words (works for long queries)
   * - DuckDuckGo Instant Answer via JSONP (featured snippet)
   * - Attempt to fetch DuckDuckGo HTML via AllOrigins proxy to extract SERP (best-effort)
   * - Smooth lift animation + card rendering + favicons + safe escaping
   *
   * Notes:
   * - AllOrigins proxy is used as a best-effort approach for extracting SERP; it may rate-limit.
   * - If external parsing fails, we fallback to showing links to DuckDuckGo/Google/Bing.
   ************************************************************************/

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ====== Your Firebase config (use your config) ======
  const firebaseConfig = {
    apiKey: "AIzaSyCXPSk94YKKNIVOGnyhnDyuK8-KGPMZJog",
    authDomain: "lumos-f100f.firebaseapp.com",
    projectId: "lumos-f100f",
    storageBucket: "lumos-f100f.firebasestorage.app",
    messagingSenderId: "229952787613",
    appId: "1:229952787613:web:b173816977d0301d5ef074",
    measurementId: "G-13QWTHDGH7"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM
  const qInput = document.getElementById('q');
  const goBtn = document.getElementById('go');
  const statusEl = document.getElementById('status');
  const resultsEl = document.getElementById('results');
  const header = document.getElementById('header');
  const viewer = document.getElementById('viewer');
  const frame = document.getElementById('frame');
  const extDuck = document.getElementById('extDuck');

  // helpers
  function escapeText(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function stripTags(html){ return String(html).replace(/<script[\s\S]*?<\/script>/gi,'').replace(/<\/?[^>]+(>|$)/g,' '); }
  function firstNWords(text, n=10){ return (text||'').split(/\s+/).filter(Boolean).slice(0,n).join(' ') + ((text||'').split(/\s+/).length>n ? '...' : ''); }
  function domainFromUrl(u){ try{ const url = new URL(u); return url.hostname; }catch(e){ return u; } }
  function faviconFor(url){ try{ const h = domainFromUrl(url); return 'https://www.google.com/s2/favicons?sz=64&domain=' + encodeURIComponent(h); } catch(e){ return ''; } }

  // animate lift
  function lift(){ header.classList.add('lift'); window.scrollTo({top:0,behavior:'smooth'}); }
  function unlift(){ header.classList.remove('lift'); }

  // render result card
  function renderCard({title, url, snippet, favicon, internal=false, id}) {
    const wrap = document.createElement('div'); wrap.className='result';
    const fav = document.createElement('div'); fav.className='favicon';
    const img = document.createElement('img'); img.alt='';
    img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    if(favicon) img.src = favicon; else img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#ffe78e"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="26">L</text></svg>');
    fav.appendChild(img);
    wrap.appendChild(fav);

    const body = document.createElement('div'); body.className='res-body';
    const t = document.createElement('div'); t.className='res-title'; t.innerHTML = escapeText(title || (id? (id + '.lumos') : url || ''));
    body.appendChild(t);
    if(url){
      const u = document.createElement('div'); u.className='res-url'; u.textContent = url;
      body.appendChild(u);
    }
    if(snippet){
      const s = document.createElement('div'); s.className='res-snippet'; s.textContent = snippet;
      body.appendChild(s);
    }

    const actions = document.createElement('div'); actions.className='res-actions';
    if(internal){
      const open = document.createElement('a'); open.href='#'; open.className='link-btn'; open.textContent='–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ Lumos';
      open.addEventListener('click', (e)=>{ e.preventDefault(); openInternal(id); });
      actions.appendChild(open);
    } else {
      if(url){
        const open = document.createElement('a'); open.href=url; open.target='_blank'; open.rel='noopener'; open.className='link-btn'; open.textContent='–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É';
        actions.appendChild(open);
      }
      const show = document.createElement('a'); show.href='https://duckduckgo.com/?q=' + encodeURIComponent(title || url || ''); show.target='_blank'; show.rel='noopener'; show.className='link-btn'; show.textContent='–ü–æ–∫–∞–∑–∞—Ç—å –≤ DuckDuckGo';
      actions.appendChild(show);
    }
    body.appendChild(actions);
    wrap.appendChild(body);
    resultsEl.appendChild(wrap);
    return wrap;
  }

  // open internal site (render in iframe)
  async function openInternal(name){
    statusEl.textContent = '–ó–∞–≥—Ä—É–∂–∞—é ' + name + '.lumos';
    try{
      const snap = await getDocs(collection(db, 'domains'));
      let data = null;
      snap.forEach(d => { if(d.id === name) data = d.data(); });
      if(!data){ statusEl.textContent = '–°–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'; return; }
      const html = data.siteHtml || `<h1>${escapeText(name)}</h1><p>–ü—É—Å—Ç–æ–π —Å–∞–π—Ç.</p>`;
      frame.srcdoc = html;
      viewer.style.display = 'block';
      statusEl.textContent = '–û—Ç–∫—Ä—ã—Ç ' + name + '.lumos';
    }catch(err){
      statusEl.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
    }
  }

  // DuckDuckGo Instant Answer (JSONP)
  function duckInstant(query, timeout = 6000){
    return new Promise((resolve, reject)=>{
      const cb = 'lumos_dd_cb_' + Math.floor(Math.random()*1e9);
      const script = document.createElement('script');
      const url = 'https://api.duckduckgo.com/?q=' + encodeURIComponent(query) + '&format=json&no_html=1&skip_disambig=1&callback=' + cb;
      let timer = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, timeout);
      window[cb] = function(data){ clearTimeout(timer); cleanup(); resolve(data || {}); };
      script.src = url;
      script.onerror = function(){ clearTimeout(timer); cleanup(); reject(new Error('network')); };
      function cleanup(){ try{ delete window[cb]; }catch(e){} if(script.parentNode) script.parentNode.removeChild(script); }
      document.head.appendChild(script);
    });
  }

  // Attempt to fetch DuckDuckGo HTML via AllOrigins proxy and parse first results (best-effort)
  async function fetchDuckSERP(query){
    // allorigins raw endpoint returns page HTML and supports CORS
    const ddUrl = 'https://duckduckgo.com/html?q=' + encodeURIComponent(query);
    const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(ddUrl);
    try{
      const r = await fetch(proxy, {cache:'no-store'});
      if(!r.ok) throw new Error('proxy fetch failed');
      const text = await r.text();
      // quick and dirty parse: find result blocks ‚Äî duckduckgo uses <a rel="nofollow" class="result__a" href="...">Title</a> and snippet in .result__snippet
      // We'll use regex to extract first 6 anchors and nearby snippet text ‚Äî fragile but works often
      const results = [];
      // Match links and surrounding snippet
      const linkRegex = /<a[^>]*class="result__a"[^>]*href="([^"]+)"[^>]*>([\s\S]*?)<\/a>/gi;
      let m;
      while((m = linkRegex.exec(text)) && results.length < 8){
        const url = m[1];
        const rawTitle = m[2].replace(/<\/?[^>]+(>|$)/g, ' ');
        // find snippet after the link
        const after = text.slice(m.index, m.index + 800);
        const snippetMatch = after.match(/<a[^>]*class="result__a"[^>]*>[\s\S]*?<\/a>[\s\S]*?<a[^>]*class="result__snippet"[^>]*>([\s\S]*?)<\/a>/i);
        let snippet = '';
        if(snippetMatch && snippetMatch[1]) snippet = snippetMatch[1].replace(/<\/?[^>]+(>|$)/g,' ').trim();
        if(!snippet){
          // fallback: try to pick a few words after the link
          snippet = after.replace(/<\/?[^>]+(>|$)/g,' ').split(/\s+/).slice(0,14).join(' ');
        }
        results.push({title: rawTitle.trim(), url, snippet: snippet.trim()});
      }
      return results;
    }catch(e){
      console.warn('Duck SERP parse failed:', e);
      return null; // indicate failure -> fallback to links
    }
  }

  // Search logic: internal (Firestore) by words, then Instant Answer, then external SERP (best-effort)
  goBtn.addEventListener('click', ()=> doSearch(qInput.value));
  qInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') doSearch(qInput.value); });

  async function doSearch(raw){
    const q = (raw||'').trim();
    if(!q){ statusEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å'; return; }
    lift();
    statusEl.textContent = '–ò—â–µ–º: ' + q;
    resultsEl.innerHTML = '';
    viewer.style.display = 'none';
    extDuck.href = 'https://duckduckgo.com/?q=' + encodeURIComponent(q);

    // 1) if it's like name.lumos => open internal
    if(q.toLowerCase().endsWith('.lumos')){
      const name = q.slice(0, -6).toLowerCase();
      // quick find
      try{
        const snap = await getDocs(collection(db, 'domains'));
        let found = false;
        snap.forEach(d => { if(d.id === name) found = true; });
        if(found){ openInternal(name); statusEl.textContent = '–û—Ç–∫—Ä—ã–≤–∞—é ' + name + '.lumos'; return; }
        else { resultsEl.innerHTML = `<div class="result"><div class="res-body"><div class="res-title">–°–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div><div class="res-snippet">–ü–æ–¥–¥–æ–º–µ–Ω ${escapeText(name)} –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.</div></div></div>`; statusEl.textContent = '–ì–æ—Ç–æ–≤–æ'; return; }
      }catch(err){ resultsEl.innerHTML = `<div class="result"><div class="res-body">–û—à–∏–±–∫–∞: ${escapeText(err.message)}</div></div>`; return; }
    }

    // 2) internal search (Firestore) ‚Äî match by words
    try{
      resultsEl.innerHTML = `<div class="muted">–ò—â–µ–º –≤–Ω—É—Ç—Ä–∏ Lumos...</div>`;
      const snap = await getDocs(collection(db, 'domains'));
      const qWords = q.toLowerCase().split(/\s+/).filter(Boolean);
      const matches = [];
      snap.forEach(d=>{
        const data = d.data();
        const hay = ((data.title||'') + ' ' + (data.description||'') + ' ' + (Array.isArray(data.keywords)? data.keywords.join(' '): '') + ' ' + d.id).toLowerCase();
        // require that each word exists somewhere (AND). If you want OR, replace with some()
        const ok = qWords.every(w => hay.indexOf(w) !== -1);
        if(ok) matches.push({id:d.id, ...data});
      });

      resultsEl.innerHTML = '';
      if(matches.length){
        for(const m of matches){
          const snippet = m.description ? firstNWords(stripTags(m.description), 12) : (m.siteHtml ? firstNWords(stripTags(m.siteHtml), 12) : '');
          renderCard({title: m.title || (m.id + '.lumos'), url: `https://${location.host}/sites/${m.id}/`, snippet, favicon: '', internal:true, id:m.id});
        }
      } else {
        // no internal matches -> small notice, will continue to external results
        resultsEl.innerHTML = `<div class="result"><div class="res-body"><div class="res-title">–í–Ω—É—Ç—Ä–∏ Lumos –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div><div class="res-snippet">–ò—â–µ–º –≤–Ω–µ—à–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã...</div></div></div>`;
      }
    }catch(err){
      resultsEl.innerHTML = `<div class="result"><div class="res-body">–û—à–∏–±–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–æ–∏—Å–∫–∞: ${escapeText(err.message)}</div></div>`;
    }

    // 3) Instant Answer (DuckDuckGo) ‚Äî JSONP
    try{
      const inst = await duckInstant(q).catch(()=>null);
      if(inst && (inst.AbstractText || inst.Heading)){
        const title = inst.Heading || q;
        const snippet = inst.AbstractText ? firstNWords(inst.AbstractText, 24) : '';
        const url = inst.AbstractURL || ('https://duckduckgo.com/?q=' + encodeURIComponent(q));
        const fav = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#ffe78e"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="26">A</text></svg>');
        // insert top
        const top = renderCard({title, url, snippet, favicon: fav, internal:false});
        resultsEl.insertBefore(top, resultsEl.firstChild);
      }
    }catch(e){ console.warn('Instant failed', e); }

    // 4) External SERP (best effort using AllOrigins proxy)
    let externalResults = null;
    try{
      externalResults = await fetchDuckSERP(q);
    }catch(e){ externalResults = null; }
    if(Array.isArray(externalResults) && externalResults.length){
      // render first few
      for(const r of externalResults.slice(0,8)){
        const fav = faviconFor(r.url || r.title);
        const snippet = firstNWords(stripTags(r.snippet || ''), 12);
        renderCard({title: stripTags(r.title || r.url), url: r.url, snippet, favicon: fav, internal:false});
      }
    } else {
      // fallback: show links to search engines
      const qEnc = encodeURIComponent(q);
      const fallbackCard = document.createElement('div'); fallbackCard.className='result';
      const favDiv = document.createElement('div'); favDiv.className='favicon';
      favDiv.innerHTML = '<img src="data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#e9f2ff"/></svg>') + '" style="width:100%;height:100%;object-fit:cover">';
      fallbackCard.appendChild(favDiv);
      const body = document.createElement('div'); body.className='res-body';
      const titleEl = document.createElement('div'); titleEl.className='res-title'; titleEl.textContent = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö';
      body.appendChild(titleEl);
      const links = document.createElement('div'); links.style.display='flex'; links.style.gap='8px'; links.style.marginTop='6px';
      const mk = (name, url) => { const a = document.createElement('a'); a.href=url; a.target='_blank'; a.rel='noopener'; a.className='link-btn'; a.textContent=name; return a; };
      links.appendChild(mk('DuckDuckGo', 'https://duckduckgo.com/?q=' + qEnc));
      links.appendChild(mk('Google', 'https://www.google.com/search?q=' + qEnc));
      links.appendChild(mk('Bing', 'https://www.bing.com/search?q=' + qEnc));
      body.appendChild(links);
      fallbackCard.appendChild(body);
      resultsEl.appendChild(fallbackCard);
    }

    statusEl.textContent = '–ì–æ—Ç–æ–≤–æ';
  }

  // initial focus
  setTimeout(()=> qInput.focus(), 250);
  </script>
</body>
</html>
