<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lumos ‚Äî –ü–æ–∏—Å–∫</title>
  <meta name="description" content="Lumos ‚Äî –ø–æ–∏—Å–∫ + –º–∏–Ω–∏-—Å–∞–π—Ç—ã" />
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{
      --bg:#ffffff; --accent:#ffd428; --muted:#6b7280; --card:#fff; --maxw:980px;
      font-family: Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#111827}
    .page{min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:28px;box-sizing:border-box}
    .wrap{width:100%;max-width:var(--maxw)}
    /* header */
    header.top{display:flex;flex-direction:column;align-items:center;gap:8px;transition:all .28s ease}
    header.top.small{align-items:flex-start;padding-top:6px}
    .logo{width:82px;height:82px;border-radius:18px;background:linear-gradient(135deg,#fff6d6,#ffe78e);display:flex;align-items:center;justify-content:center;font-size:40px;box-shadow:0 10px 30px rgba(0,0,0,0.06)}
    h1{margin:0;font-size:22px}
    p.lead{margin:0;color:var(--muted);font-size:14px}
    /* search */
    .search-wrap{margin-top:18px;display:flex;justify-content:center}
    .search-card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 8px 30px rgba(2,6,23,0.04);width:100%}
    .search-row{display:flex;gap:8px;align-items:center}
    input#q{flex:1;padding:14px 12px;border-radius:10px;border:1px solid #e8e9eb;font-size:16px;outline:none}
    button#go{background:var(--accent);border:0;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 8px 18px rgba(255,212,40,0.12)}
    /* layout results */
    .main{display:flex;gap:18px;margin-top:18px}
    .left{flex:1}
    .right{width:360px}
    @media(max-width:920px){ .main{flex-direction:column}.right{width:100%} header.top.small{align-items:center} }
    /* result card like Google */
    .results{display:flex;flex-direction:column;gap:12px}
    .result{padding:14px;border-radius:8px;background:#fff;border:1px solid #eef0f2;display:flex;gap:12px;align-items:flex-start}
    .favicon{width:48px;height:48px;border-radius:8px;flex:0 0 48px;background:#fafafa;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .res-body{flex:1}
    .res-title{font-size:15px;font-weight:700;color:#1a202c;margin-bottom:6px}
    .res-url{font-size:13px;color:#0456a6;margin-bottom:6px;word-break:break-all}
    .res-snippet{font-size:14px;color:var(--muted)}
    /* viewer iframe */
    .viewer{margin-top:12px;border:1px solid #e9eef2;border-radius:10px;overflow:hidden}
    .viewer iframe{width:100%;height:420px;border:0}
    /* small */
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">
      <header id="header" class="top">
        <div class="logo">üçã</div>
        <h1>Lumos</h1>
        <p class="lead">–ü–æ–∏—Å–∫ –ø–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ –º–∏–Ω–∏-—Å–∞–π—Ç–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
      </header>

      <div class="search-wrap">
        <div class="search-card">
          <div class="search-row">
            <input id="q" placeholder="–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏? –ù–∞–ø—Ä–∏–º–µ—Ä: –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–æ–ª–Ω—Ü–µ" />
            <button id="go">–ü–æ–∏—Å–∫</button>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div id="status" class="muted">–ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É</div>
            <div class="muted">–ú—ã —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ–º —Å DuckDuckGo</div>
          </div>
        </div>
      </div>

      <div class="main">
        <div class="left">
          <div id="results" class="results">
            <div class="muted">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∏—Å–∫¬ª ‚Äî Lumos —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç –≤–Ω—É—Ç—Ä–∏ —Å–≤–æ–∏—Ö –º–∏–Ω–∏-—Å–∞–π—Ç–æ–≤, –∑–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤–∏–∫–∏.</div>
          </div>

          <div id="viewer" class="viewer" style="display:none;margin-top:12px">
            <iframe id="frame" sandbox="allow-scripts allow-forms allow-modals"></iframe>
          </div>
        </div>

        <aside class="right">
          <div style="padding:12px;border-radius:10px;border:1px solid #eef0f2;background:#fff">
            <div style="font-weight:700">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Lumos</div>
            <div class="muted" style="margin-top:8px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–∏–Ω–∏-—Å–∞–π—Ç—ã —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å. –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.</div>
            <div style="margin-top:12px">
              <a id="duckLink" class="muted" href="#" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –≤ DuckDuckGo</a>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
  // ---------- Firebase initialization (your config) ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  // use only Firestore here (no auth required for search)
  const firebaseConfig = {
    apiKey: "AIzaSyCXPSk94YKKNIVOGnyhnDyuK8-KGPMZJog",
    authDomain: "lumos-f100f.firebaseapp.com",
    projectId: "lumos-f100f",
    storageBucket: "lumos-f100f.firebasestorage.app",
    messagingSenderId: "229952787613",
    appId: "1:229952787613:web:b173816977d0301d5ef074",
    measurementId: "G-13QWTHDGH7"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- DOM ----------
  const qInput = document.getElementById('q');
  const goBtn = document.getElementById('go');
  const resultsEl = document.getElementById('results');
  const header = document.getElementById('header');
  const statusEl = document.getElementById('status');
  const viewer = document.getElementById('viewer');
  const frame = document.getElementById('frame');
  const duckLink = document.getElementById('duckLink');

  // utils
  function escapeText(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function domainFromUrl(u){ try{ const url=new URL(u); return url.hostname; }catch(e){ return u; } }

  // animate search to top like Google
  function liftSearchBar(){ header.classList.add('small'); window.scrollTo({top:0, behavior:'smooth'}); }

  // build a result card DOM
  function makeResultCard({title, url, snippet, favicon, isInternal=false, id}) {
    const wrap = document.createElement('div'); wrap.className = 'result';
    const fav = document.createElement('div'); fav.className='favicon';
    const img = document.createElement('img');
    img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    img.alt = '';
    if(favicon) img.src = favicon;
    else img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#ffe78e"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="26" font-family="Arial">L</text></svg>');
    fav.appendChild(img);
    wrap.appendChild(fav);

    const body = document.createElement('div'); body.className='res-body';
    const t = document.createElement('div'); t.className='res-title'; t.textContent = title || (id? (id + '.lumos') : url);
    body.appendChild(t);
    if(url){
      const u = document.createElement('div'); u.className='res-url'; u.textContent = url;
      body.appendChild(u);
    }
    if(snippet){
      const s = document.createElement('div'); s.className='res-snippet';
      s.textContent = snippet;
      body.appendChild(s);
    }
    // actions
    const actions = document.createElement('div'); actions.style.marginTop='8px';
    if(isInternal){
      const open = document.createElement('a'); open.href='#'; open.className='muted'; open.textContent='–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ Lumos';
      open.addEventListener('click', (ev)=>{ ev.preventDefault(); openInternalSite(id); });
      actions.appendChild(open);
    } else {
      if(url){
        const go = document.createElement('a'); go.href = url; go.target='_blank'; go.rel='noopener'; go.textContent='–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É';
        go.style.marginRight='8px';
        actions.appendChild(go);
      }
      const ext = document.createElement('a'); ext.href=`https://duckduckgo.com/?q=${encodeURIComponent(title || url)}`; ext.target='_blank'; ext.rel='noopener'; ext.textContent='–ü–æ–∫–∞–∑–∞—Ç—å –≤ DuckDuckGo';
      actions.appendChild(ext);
    }
    body.appendChild(actions);

    wrap.appendChild(body);
    return wrap;
  }

  // open internal site from Firestore content (in iframe)
  async function openInternalSite(name){
    try{
      statusEl.textContent = '–ó–∞–≥—Ä—É–∂–∞—é —Å–∞–π—Ç ' + name + '.lumos';
      // fetch document
      const snap = await getDocs(collection(db, 'domains'));
      let docData = null;
      snap.forEach(d => { if(d.id === name) docData = d.data(); });
      if(!docData){
        statusEl.textContent = '–°–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω';
        return;
      }
      const html = docData.siteHtml || `<h1>${escapeText(name)}</h1><p>–ü—É—Å—Ç–æ–π —Å–∞–π—Ç.</p>`;
      frame.srcdoc = html;
      viewer.style.display = 'block';
      statusEl.textContent = '–û—Ç–∫—Ä—ã—Ç ' + name + '.lumos';
    }catch(e){
      statusEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
    }
  }

  // DuckDuckGo JSONP Instant Answer fetch
  function duckInstant(query, timeout=7000){
    return new Promise((resolve, reject)=>{
      const cb = 'lumos_dd_cb_' + Math.floor(Math.random()*1e9);
      const script = document.createElement('script');
      script.src = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_redirect=1&skip_disambig=1&callback=${cb}`;
      let timer = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, timeout);
      window[cb] = function(data){ clearTimeout(timer); cleanup(); resolve(data); };
      script.onerror = function(){ clearTimeout(timer); cleanup(); reject(new Error('network')); };
      function cleanup(){ try{ delete window[cb]; }catch(e){} if(script.parentNode) script.parentNode.removeChild(script); }
      document.head.appendChild(script);
    });
  }

  // main search
  async function doSearch(raw){
    const q = (raw||'').trim();
    if(!q){ statusEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å'; return; }
    liftSearchBar();
    statusEl.textContent = '–ò—â–µ–º: ' + q;
    resultsEl.innerHTML = '';
    viewer.style.display = 'none';

    // 1) If it's a "site" like name.lumos -> direct internal open
    if(q.toLowerCase().endsWith('.lumos')){
      const name = q.slice(0, -6).toLowerCase();
      // find doc in Firestore
      try{
        const snap = await getDocs(collection(db, 'domains'));
        let found = false;
        snap.forEach(d => { if(d.id === name){ found = true; }});
        if(found){ openInternalSite(name); return; }
        else { resultsEl.innerHTML = `<div class="result"><div class="res-body"><div class="res-title">–°–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div><div class="res-snippet">–ü–æ–¥–¥–æ–º–µ–Ω ${escapeText(name)} –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ Lumos.</div></div></div>`; return; }
      }catch(e){ resultsEl.innerHTML = `<div class="result"><div class="res-body">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${escapeText(e.message)}</div></div>`; return; }
    }

    // 2) internal search (Firestore) ‚Äî client-side filtering
    try{
      resultsEl.innerHTML = `<div class="muted">–ò—â–µ–º –≤–Ω—É—Ç—Ä–∏ Lumos...</div>`;
      const snap = await getDocs(collection(db, 'domains'));
      const ql = q.toLowerCase();
      const matches = [];
      snap.forEach(d=>{
        const data = d.data();
        const hay = ((data.title||'') + ' ' + (data.description||'') + ' ' + (Array.isArray(data.keywords)? data.keywords.join(' '): '') + ' ' + d.id).toLowerCase();
        if(hay.indexOf(ql) !== -1) matches.push({id:d.id, ...data});
      });

      resultsEl.innerHTML = '';
      if(matches.length){
        for(const m of matches){
          const snippet = (m.description && m.description.split(/\s+/).slice(0,12).join(' ') + '...') || (m.siteHtml && stripText(m.siteHtml, 12)) || '';
          const favicon = ''; // internal: show L icon or can derive from owner
          const card = makeResultCard({title: m.title || (m.id + '.lumos'), url: `https://${location.host}/sites/${m.id}/`, snippet, favicon, isInternal:true, id:m.id});
          resultsEl.appendChild(card);
        }
      } else {
        resultsEl.innerHTML = `<div class="result"><div class="res-body"><div class="res-title">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ Lumos</div><div class="res-snippet">–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤–∏–∫–∏.</div></div></div>`;
      }
    }catch(e){
      resultsEl.innerHTML = `<div class="result"><div class="res-body">–û—à–∏–±–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–æ–∏—Å–∫–∞: ${escapeText(e.message)}</div></div>`;
    }

    // 3) DuckDuckGo Instant Answer (featured snippet) - show as top card if available
    try{
      const data = await duckInstant(q);
      // Choose text from AbstractText or Heading or RelatedTopics
      let snippet = '';
      let title = '';
      let sourceUrl = '';
      if(data){
        if(data.Heading) title = data.Heading;
        if(data.AbstractText) snippet = data.AbstractText;
        if(data.AbstractURL) sourceUrl = data.AbstractURL;
      }
      if(snippet || title){
        // place it at top visually
        const fav = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#ffe78e"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="26" font-family="Arial">A</text></svg>');
        const topCard = makeResultCard({title: title || q, url: sourceUrl || ('https://duckduckgo.com/?q=' + encodeURIComponent(q)), snippet: snippet, favicon: fav, isInternal:false});
        // insert at top
        resultsEl.insertBefore(topCard, resultsEl.firstChild);
      }
    }catch(e){
      // ignore instant errors (timeout/network)
      console.warn('Duck instant error', e);
    }

    // 4) add external search suggestions (Duck/Google/Bing)
    const qEnc = encodeURIComponent(q);
    const extCard = document.createElement('div'); extCard.className='result';
    const favDiv = document.createElement('div'); favDiv.className='favicon';
    favDiv.innerHTML = '<img src="data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#e9f2ff"/></svg>') + '" style="width:100%;height:100%;object-fit:cover">';
    extCard.appendChild(favDiv);
    const body = document.createElement('div'); body.className='res-body';
    const titleEl = document.createElement('div'); titleEl.className='res-title'; titleEl.textContent = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö';
    body.appendChild(titleEl);
    const linksDiv = document.createElement('div'); linksDiv.style.display='flex'; linksDiv.style.gap='8px'; linksDiv.style.marginTop='6px';
    const mk = (name, url) => { const a = document.createElement('a'); a.href=url; a.target='_blank'; a.rel='noopener'; a.className='muted'; a.textContent=name; return a; };
    linksDiv.appendChild(mk('DuckDuckGo', 'https://duckduckgo.com/?q='+qEnc));
    linksDiv.appendChild(mk('Google', 'https://www.google.com/search?q='+qEnc));
    linksDiv.appendChild(mk('Bing', 'https://www.bing.com/search?q='+qEnc));
    body.appendChild(linksDiv);
    extCard.appendChild(body);
    resultsEl.appendChild(extCard);

    // update side link
    duckLink.href = 'https://duckduckgo.com/?q=' + qEnc;
    statusEl.textContent = '–ì–æ—Ç–æ–≤–æ';
  }

  // helper: strip tags and return first N words
  function stripText(html, words = 12){
    const tmp = html.replace(/<script[\s\S]*?<\/script>/gi,'').replace(/<\/?[^>]+(>|$)/g, ' ');
    return tmp.split(/\s+/).filter(Boolean).slice(0,words).join(' ') + (tmp.split(/\s+/).length > words ? '...' : '');
  }

  // fav icon helper (Google's s2 service)
  function faviconFor(url){
    try{ const hostname = domainFromUrl(url); return 'https://www.google.com/s2/favicons?sz=64&domain=' + encodeURIComponent(hostname); }catch(e){ return ''; }
  }

  // wire UI
  goBtn.addEventListener('click', ()=> doSearch(qInput.value));
  qInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') doSearch(qInput.value); });

  // initial focus
  setTimeout(()=> qInput.focus(),300);

  // End of module
  </script>
</body>
</html>
