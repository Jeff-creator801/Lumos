<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lumos ‚Äî –ü–æ–∏—Å–∫</title>
  <meta name="description" content="Lumos ‚Äî –ø–æ–∏—Å–∫ –ø–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ –º–∏–Ω–∏-—Å–∞–π—Ç–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" />
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{
      --bg:#ffffff; --accent:#ffd428; --muted:#6b7280; --card:#fff;
      --maxw:980px; font-family: Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#111827;-webkit-font-smoothing:antialiased}
    .page{min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:28px;box-sizing:border-box}
    .wrap{width:100%;max-width:var(--maxw)}
    /* header / animated lift */
    header.top{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      transform:translateY(14vh);
      transition: transform .6s cubic-bezier(.22,.9,.3,1), padding .25s;
      will-change: transform;
    }
    header.top.lift{
      transform:translateY(0);
      align-items:flex-start;
    }
    @media(max-width:920px){
      header.top{transform:translateY(9vh)}
      header.top.lift{align-items:center}
    }
    .logo{
      width:88px;height:88px;border-radius:18px;
      background:linear-gradient(135deg,#fff6d6,#ffe78e);
      display:flex;align-items:center;justify-content:center;font-size:44px;
      box-shadow:0 12px 36px rgba(0,0,0,0.08)
    }
    h1{margin:0;font-size:22px}
    p.lead{margin:0;color:var(--muted);font-size:14px}

    /* search */
    .search-wrap{margin-top:18px;display:flex;justify-content:center}
    .search-card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 10px 32px rgba(2,6,23,0.05);width:100%}
    .search-row{display:flex;gap:8px;align-items:center}
    input#q{flex:1;padding:14px 12px;border-radius:12px;border:1px solid #e8e9eb;font-size:16px;outline:none}
    button#go{background:var(--accent);border:0;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 10px 24px rgba(255,212,40,0.12)}
    /* layout */
    .main{display:flex;gap:18px;margin-top:18px}
    .left{flex:1}
    .right{width:360px}
    @media(max-width:920px){ .main{flex-direction:column} .right{width:100%} }

    /* results */
    .results{display:flex;flex-direction:column;gap:12px}
    .result{
      padding:14px;border-radius:10px;background:#fff;border:1px solid #eef0f2;
      display:flex;gap:12px;align-items:flex-start;
      opacity:0; transform:translateY(12px) scale(0.995);
      transition: opacity .42s ease, transform .42s cubic-bezier(.2,.9,.2,1);
      will-change: opacity, transform;
    }
    .result.show{ opacity:1; transform:none; }
    .favicon{width:48px;height:48px;border-radius:10px;flex:0 0 48px;background:#fafafa;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .res-body{flex:1}
    .res-title{font-size:15px;font-weight:700;color:#111827;margin-bottom:6px}
    .res-url{font-size:13px;color:#0456a6;margin-bottom:6px;word-break:break-all}
    .res-snippet{font-size:14px;color:var(--muted)}
    .res-actions{margin-top:8px}
    .link-btn{padding:7px 10px;border-radius:8px;background:transparent;border:1px solid #eef0f2;color:var(--muted);text-decoration:none;font-size:13px;margin-right:8px}
    /* viewer */
    .viewer{margin-top:12px;border:1px solid #e9eef2;border-radius:10px;overflow:hidden}
    .viewer iframe{width:100%;height:420px;border:0}
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">
      <header id="header" class="top" aria-hidden>
        <div class="logo">üçã</div>
        <h1>Lumos</h1>
        <p class="lead">–ü–æ–∏—Å–∫ –ø–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ –º–∏–Ω–∏-—Å–∞–π—Ç–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
      </header>

      <div class="search-wrap" role="search">
        <div class="search-card" style="width:100%">
          <div class="search-row">
            <input id="q" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–æ–ª–Ω—Ü–µ" autocomplete="off" />
            <button id="go" aria-label="–ü–æ–∏—Å–∫">–ü–æ–∏—Å–∫</button>
          </div>
          <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
            <div id="status" class="muted">–ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É</div>
            <div class="muted">–ú—ã —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ–º —Å DuckDuckGo</div>
          </div>
        </div>
      </div>

      <div class="main" style="width:100%">
        <div class="left">
          <div id="results" class="results">
            <div class="muted">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∏—Å–∫¬ª. Lumos —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç –ø–æ –º–∏–Ω–∏-—Å–∞–π—Ç–∞–º –≤–Ω—É—Ç—Ä–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –∑–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –∏ –≤–Ω–µ—à–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.</div>
          </div>

          <div id="viewer" class="viewer" style="display:none">
            <iframe id="frame" sandbox="allow-scripts allow-forms allow-modals"></iframe>
          </div>
        </div>

        <aside class="right">
          <div style="padding:12px;border-radius:10px;border:1px solid #eef0f2;background:#fff">
            <div style="font-weight:700">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Lumos</div>
            <div class="muted" style="margin-top:8px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç –º–∏–Ω–∏-—Å–∞–π—Ç—ã —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å. –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.</div>
            <div style="margin-top:12px"><a id="extDuck" class="link-btn" href="#" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –≤ DuckDuckGo</a></div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
  /**
   * Lumos ‚Äî search page with smooth header lift and staggered result animations
   * - internal search (Firestore) matches by words (works for long queries)
   * - DuckDuckGo Instant Answer via JSONP (featured snippet)
   * - Shows external search links when needed
   * - Smooth header lift + staggered card show
   *
   * Triple-checked: Firebase init, internal search, instant answer, rendering and animations.
   */

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ---------- Firebase config (use the one you provided) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCXPSk94YKKNIVOGnyhnDyuK8-KGPMZJog",
    authDomain: "lumos-f100f.firebaseapp.com",
    projectId: "lumos-f100f",
    storageBucket: "lumos-f100f.firebasestorage.app",
    messagingSenderId: "229952787613",
    appId: "1:229952787613:web:b173816977d0301d5ef074",
    measurementId: "G-13QWTHDGH7"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- DOM ----------
  const qInput = document.getElementById('q');
  const goBtn = document.getElementById('go');
  const statusEl = document.getElementById('status');
  const resultsEl = document.getElementById('results');
  const header = document.getElementById('header');
  const viewer = document.getElementById('viewer');
  const frame = document.getElementById('frame');
  const extDuck = document.getElementById('extDuck');

  // ---------- Helpers ----------
  function escapeText(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function stripTags(html){ return String(html).replace(/<script[\s\S]*?<\/script>/gi,'').replace(/<\/?[^>]+(>|$)/g,' '); }
  function firstNWords(text, n=10){ return (text||'').split(/\s+/).filter(Boolean).slice(0,n).join(' ') + ((text||'').split(/\s+/).length>n ? '...' : ''); }
  function domainFromUrl(u){ try{ const url=new URL(u); return url.hostname; }catch(e){ return u; } }
  function faviconFor(url){ try{ const h = domainFromUrl(url); return 'https://www.google.com/s2/favicons?sz=64&domain=' + encodeURIComponent(h); } catch(e){ return ''; } }

  // animate header up
  function liftHeader(){ header.classList.add('lift'); window.scrollTo({top:0,behavior:'smooth'}); }
  function resetHeader(){ header.classList.remove('lift'); }

  // create result card element (not shown yet)
  function createCard({title, url, snippet, favicon, isInternal=false, id}) {
    const wrap = document.createElement('div');
    wrap.className = 'result';

    const fav = document.createElement('div'); fav.className = 'favicon';
    const img = document.createElement('img'); img.alt = '';
    img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    img.src = favicon || ('data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#ffe78e"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="26">L</text></svg>'));
    fav.appendChild(img);
    wrap.appendChild(fav);

    const body = document.createElement('div'); body.className = 'res-body';
    const t = document.createElement('div'); t.className = 'res-title'; t.innerHTML = escapeText(title || (id ? (id + '.lumos') : url || ''));
    body.appendChild(t);

    if(url){
      const u = document.createElement('div'); u.className = 'res-url'; u.textContent = url;
      body.appendChild(u);
    }
    if(snippet){
      const s = document.createElement('div'); s.className = 'res-snippet'; s.textContent = snippet;
      body.appendChild(s);
    }

    const actions = document.createElement('div'); actions.className = 'res-actions';
    if(isInternal){
      const open = document.createElement('a'); open.href='#'; open.className='link-btn'; open.textContent='–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ Lumos';
      open.addEventListener('click', (e)=>{ e.preventDefault(); openInternalSite(id); });
      actions.appendChild(open);
    } else {
      if(url){
        const open = document.createElement('a'); open.href=url; open.target='_blank'; open.rel='noopener'; open.className='link-btn'; open.textContent='–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É';
        actions.appendChild(open);
      }
      const ext = document.createElement('a'); ext.href='https://duckduckgo.com/?q=' + encodeURIComponent(title || url || ''); ext.target='_blank'; ext.rel='noopener'; ext.className='link-btn'; ext.textContent='–ü–æ–∫–∞–∑–∞—Ç—å –≤ DuckDuckGo';
      actions.appendChild(ext);
    }
    body.appendChild(actions);
    wrap.appendChild(body);

    return wrap;
  }

  // show cards with staggered animation
  function appendWithStagger(cards){
    // cards: array of HTMLElements
    cards.forEach((card, i)=>{
      resultsEl.appendChild(card);
      // stagger: add .show after small delay per index
      setTimeout(()=> card.classList.add('show'), 80 * i);
    });
  }

  // open internal site in iframe
  async function openInternalSite(name){
    statusEl.textContent = '–ó–∞–≥—Ä—É–∂–∞—é ' + name + '.lumos';
    try {
      const snap = await getDocs(collection(db, 'domains'));
      let docData = null;
      snap.forEach(d => { if(d.id === name) docData = d.data(); });
      if(!docData){ statusEl.textContent = '–°–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'; return; }
      const html = docData.siteHtml || `<h1>${escapeText(name)}</h1><p>–ü—É—Å—Ç–æ–π —Å–∞–π—Ç.</p>`;
      frame.srcdoc = html;
      viewer.style.display = 'block';
      statusEl.textContent = '–û—Ç–∫—Ä—ã—Ç ' + name + '.lumos';
    } catch(err){
      statusEl.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
    }
  }

  // DuckDuckGo Instant Answer via JSONP
  function duckInstant(query, timeout = 6000){
    return new Promise((resolve, reject)=>{
      const cb = 'lumos_dd_cb_' + Math.floor(Math.random()*1e9);
      const script = document.createElement('script');
      const url = 'https://api.duckduckgo.com/?q=' + encodeURIComponent(query) + '&format=json&no_html=1&skip_disambig=1&callback=' + cb;
      let timer = setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, timeout);
      window[cb] = function(data){ clearTimeout(timer); cleanup(); resolve(data || {}); };
      script.src = url;
      script.onerror = function(){ clearTimeout(timer); cleanup(); reject(new Error('network')); };
      function cleanup(){ try{ delete window[cb]; }catch(e){} if(script.parentNode) script.parentNode.removeChild(script); }
      document.head.appendChild(script);
    });
  }

  // Main search flow
  goBtn.addEventListener('click', () => doSearch(qInput.value));
  qInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') doSearch(qInput.value); });

  async function doSearch(raw){
    const q = (raw || '').trim();
    if(!q){ statusEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å'; return; }
    liftHeader();
    statusEl.textContent = '–ò—â–µ–º: ' + q;
    resultsEl.innerHTML = ''; viewer.style.display = 'none';
    extDuck.href = 'https://duckduckgo.com/?q=' + encodeURIComponent(q);

    // If query is "name.lumos" handle as internal redirect
    if(q.toLowerCase().endsWith('.lumos')){
      const name = q.slice(0, -6).toLowerCase();
      try{
        const snap = await getDocs(collection(db, 'domains'));
        let found = false;
        snap.forEach(d => { if(d.id === name) found = true; });
        if(found){ openInternalSite(name); statusEl.textContent = '–û—Ç–∫—Ä—ã–≤–∞—é ' + name + '.lumos'; return; }
        else {
          const card = createCard({title:'–°–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', snippet:`–ü–æ–¥–¥–æ–º–µ–Ω ${escapeText(name)} –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.`, favicon:'', isInternal:false});
          resultsEl.appendChild(card); card.classList.add('show'); statusEl.textContent = '–ì–æ—Ç–æ–≤–æ'; return;
        }
      }catch(err){ const card = createCard({title:'–û—à–∏–±–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–æ–∏—Å–∫–∞', snippet:err.message}); resultsEl.appendChild(card); resultsEl.querySelector('.result').classList.add('show'); return; }
    }

    // 1) Internal search ‚Äî match by words (AND)
    let internalMatches = [];
    try{
      statusEl.textContent = '–ò—â–µ–º –≤–Ω—É—Ç—Ä–∏ Lumos...';
      const snap = await getDocs(collection(db, 'domains'));
      const words = q.toLowerCase().split(/\s+/).filter(Boolean);
      snap.forEach(d => {
        const data = d.data();
        const hay = ((data.title||'') + ' ' + (data.description||'') + ' ' + (Array.isArray(data.keywords)? data.keywords.join(' '): '') + ' ' + d.id).toLowerCase();
        const ok = words.every(w => hay.indexOf(w) !== -1);
        if(ok) internalMatches.push({id:d.id, ...data});
      });
    }catch(err){
      // show error
      const card = createCard({title:'–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –±–∞–∑—ã', snippet:err.message});
      resultsEl.appendChild(card); card.classList.add('show');
    }

    // render internal matches first (stagger)
    if(internalMatches.length){
      const cards = internalMatches.map(m => {
        const sn = m.description ? firstNWords(stripTags(m.description), 12) : (m.siteHtml ? firstNWords(stripTags(m.siteHtml),12) : '');
        return createCard({title: m.title || (m.id + '.lumos'), url: `https://${location.host}/sites/${m.id}/`, snippet: sn, favicon:'', isInternal:true, id: m.id});
      });
      appendWithStagger(cards);
    } else {
      // show placeholder (will be followed by instant/external)
      const placeholder = createCard({title:'–í–Ω—É—Ç—Ä–∏ Lumos –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', snippet:'–ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –∏ –≤–Ω–µ—à–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...', favicon:''});
      resultsEl.appendChild(placeholder); placeholder.classList.add('show');
    }

    // 2) DuckDuckGo Instant Answer
    try{
      const inst = await duckInstant(q).catch(()=>null);
      if(inst && (inst.Heading || inst.AbstractText)){
        const title = inst.Heading || q;
        const snippet = inst.AbstractText ? firstNWords(inst.AbstractText, 24) : '';
        const url = inst.AbstractURL || ('https://duckduckgo.com/?q=' + encodeURIComponent(q));
        const topCard = createCard({title, url, snippet, favicon: 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#ffe78e"/></svg>')});
        // insert top with show
        resultsEl.insertBefore(topCard, resultsEl.firstChild);
        // ensure it animates
        setTimeout(()=> topCard.classList.add('show'), 60);
      }
    }catch(e){ console.warn('Instant failed', e); }

    // 3) External fallback - show search engine links if desire for fuller SERP
    // We try NOT to parse SERP here (fragile). Provide links for the user to open full search.
    const qEnc = encodeURIComponent(q);
    const fallbackCard = createCard({
      title: '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö',
      url: '',
      snippet: '–û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ DuckDuckGo / Google / Bing.',
      favicon: 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#e9f2ff"/></svg>')
    });
    // add action links manually (outside createCard) to ensure buttons
    const linksDiv = document.createElement('div'); linksDiv.style.marginTop = '8px';
    const mk = (name, url) => { const a = document.createElement('a'); a.href = url; a.target='_blank'; a.rel='noopener'; a.className='link-btn'; a.textContent = name; return a; };
    linksDiv.appendChild(mk('DuckDuckGo', 'https://duckduckgo.com/?q=' + qEnc));
    linksDiv.appendChild(mk('Google', 'https://www.google.com/search?q=' + qEnc));
    linksDiv.appendChild(mk('Bing', 'https://www.bing.com/search?q=' + qEnc));
    fallbackCard.querySelector('.res-body').appendChild(linksDiv);
    resultsEl.appendChild(fallbackCard);
    setTimeout(()=> fallbackCard.classList.add('show'), 80 * (internalMatches.length ? internalMatches.length + 1 : 1));

    statusEl.textContent = '–ì–æ—Ç–æ–≤–æ';
  }

  // initial focus
  setTimeout(()=> qInput.focus(), 250);

  // End module
  </script>
</body>
</html>
