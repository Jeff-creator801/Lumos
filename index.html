<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lumos ‚Äî –ü–æ–∏—Å–∫ –∏ –º–∏–Ω–∏-—Å–∞–π—Ç—ã</title>
  <meta name="description" content="Lumos ‚Äî –±—ã—Å—Ç—Ä—ã–π –º–æ–±–∏–ª—å–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤–∏–∫ + –º–∏–Ω–∏-—Å–∞–π—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" />
  <meta name="theme-color" content="#ffffff">
  <style>
    /* ====== –°—Ç–∏–ª—å —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º: –±–µ–ª—ã–π —Ñ–æ–Ω, –ª–∏–º–æ–Ω —Å–≤–µ—Ä—Ö—É, –∫–Ω–æ–ø–∫–∞ –∂—ë–ª—Ç–∞—è ====== */
    :root{
      --bg: #ffffff;
      --accent: #ffd428; /* –∂—ë–ª—Ç–∞—è –∫–Ω–æ–ø–∫–∞ */
      --muted: #6b7280;
      --card: #ffffff;
      --radius: 12px;
      --maxw: 920px;
      font-family: Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#111827;-webkit-font-smoothing:antialiased;}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;box-sizing:border-box;}
    .container{width:100%;max-width:var(--maxw);display:flex;flex-direction:column;align-items:center;gap:18px}
    header{display:flex;flex-direction:column;align-items:center;gap:6px}
    .logo{width:88px;height:88px;border-radius:18px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#fff6d6,#ffe78e);font-size:44px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
    h1{margin:0;font-size:22px}
    p.lead{margin:0;color:var(--muted);font-size:14px}
    /* Search card */
    .card{width:100%;background:var(--card);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.04);box-sizing:border-box}
    .search-row{display:flex;gap:8px;align-items:center}
    input.search{flex:1;padding:14px 12px;border-radius:12px;border:1px solid #e6e7eb;font-size:16px;outline:none}
    button.btn{background:var(--accent);border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer;color:#000;box-shadow:0 8px 18px rgba(255,212,40,0.12)}
    .muted{color:var(--muted);font-size:13px}
    main.sections{display:grid;grid-template-columns:1fr 360px;gap:18px;width:100%}
    @media(max-width:920px){ main.sections{grid-template-columns:1fr} }
    /* results */
    .results{display:flex;flex-direction:column;gap:12px}
    .result-item{padding:12px;border-radius:10px;border:1px solid #f0f0f0;background:#fbfbfb}
    .result-title{font-weight:700;margin-bottom:6px}
    .result-desc{color:var(--muted);font-size:13px}
    /* sidebar */
    .sidebar{display:flex;flex-direction:column;gap:12px}
    .panel{padding:12px;border-radius:12px;border:1px solid #f0f0f0;background:#fff}
    label{display:block;font-size:13px;margin-bottom:6px;color:#374151}
    input.small, textarea.small, select.small{width:100%;padding:8px;border:1px solid #e6e7eb;border-radius:8px;font-size:14px}
    textarea.small{min-height:120px}
    .tiny{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .link-btn{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid #eef0f2;color:var(--muted);text-decoration:none}
    /* viewer */
    .viewer{width:100%;min-height:360px;border-radius:12px;border:1px solid #e9ecef;overflow:hidden}
    .footer{margin-top:6px;color:var(--muted);font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="container">
      <header>
        <div class="logo" aria-hidden>üçã</div>
        <h1>Lumos</h1>
        <p class="lead">–ë—ã—Å—Ç—Ä—ã–π –º–æ–±–∏–ª—å–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤–∏–∫ ‚Äî –∏—â–µ–º –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –∏ –ø–æ –º–∏–Ω–∏-—Å–∞–π—Ç–∞–º –≤–Ω—É—Ç—Ä–∏ Lumos</p>
      </header>

      <div class="card" style="width:100%;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div class="muted">–ò—Å–∫–∞—Ç—å –≤ Lumos</div>
          <div class="muted tiny">–ñ–∏–≤–æ–π –ø–æ–∏—Å–∫ ¬∑ Mini-sites ¬∑ PWA-ready</div>
        </div>

        <div class="search-row" style="margin-bottom:10px;">
          <input id="q" class="search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ site.lumos (–Ω–∞–ø—Ä–∏–º–µ—Ä: hay.lumos)" />
          <button id="go" class="btn">–ü–æ–∏—Å–∫</button>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center">
          <div id="status" class="muted">–ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É</div>
          <div>
            <button id="btn-login" class="link-btn">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button id="btn-logout" class="link-btn" style="display:none">–í—ã–π—Ç–∏</button>
          </div>
        </div>
      </div>

      <main class="sections" style="width:100%;">
        <!-- left: results / viewer -->
        <section>
          <div id="resultsWrap" class="results">
            <div class="result-item">
              <div class="result-title">–°–æ–≤–µ—Ç</div>
              <div class="result-desc">–ü–æ–ø—Ä–æ–±—É–π –ø–æ–∏—Å–∫–∞—Ç—å ¬´demo¬ª, –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ <code>yourname.lumos</code> —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –º–∏–Ω–∏-—Å–∞–π—Ç (–µ—Å–ª–∏ –æ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω).</div>
            </div>
          </div>

          <div id="viewerWrap" style="margin-top:12px;display:none">
            <div class="panel">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div><strong id="viewerTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–∞–π—Ç–∞</strong></div>
                <div class="tiny" id="viewerMeta"></div>
              </div>
              <div class="viewer" style="margin-top:10px">
                <iframe id="siteFrame" sandbox="allow-scripts allow-forms allow-modals" style="width:100%;height:420px;border:0"></iframe>
              </div>
            </div>
          </div>
        </section>

        <!-- right: sidebar with user panel -->
        <aside class="sidebar">
          <div class="panel" id="panelAuth">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>–ü–∞–Ω–µ–ª—å –∞–∫–∫–∞—É–Ω—Ç–∞</strong></div>
              <div id="userEmail" class="tiny"></div>
            </div>
            <div id="authForms" style="margin-top:8px">
              <div id="loggedOut">
                <label>–ü–æ—á—Ç–∞</label>
                <input id="email" class="small" type="email" placeholder="email@example.com" />
                <label style="margin-top:8px">–ü–∞—Ä–æ–ª—å</label>
                <input id="password" class="small" type="password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" />
                <div style="margin-top:8px;display:flex;gap:8px">
                  <button id="btn-register" class="btn" style="padding:8px 12px">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                  <button id="btn-signin" class="link-btn">–í–æ–π—Ç–∏</button>
                </div>
              </div>
              <div id="loggedIn" style="display:none;margin-top:8px">
                <div class="tiny">–í –ø—Ä–æ—Ñ–∏–ª–µ:</div>
                <div style="margin-top:6px">
                  <button id="btn-createDomain" class="btn" style="padding:8px 12px">–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–¥–æ–º–µ–Ω</button>
                </div>
                <div style="margin-top:8px">
                  <button id="btn-editSite" class="link-btn">–†–µ–¥–∞–∫—Ç–æ—Ä —Å–∞–π—Ç–∞</button>
                </div>
                <div style="margin-top:8px">
                  <button id="btn-mySites" class="link-btn">–ú–æ–∏ —Å–∞–π—Ç—ã</button>
                </div>
              </div>
            </div>
            <div style="margin-top:10px">
              <div class="tiny">–ê–¥–º–∏–Ω: <strong>alibahsburiev@gmail.com</strong> ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤.</div>
            </div>
          </div>

          <!-- create domain panel -->
          <div class="panel" id="panelCreate" style="display:none">
            <div><strong>–°–æ–∑–¥–∞—Ç—å / –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–¥–æ–º–µ–Ω</strong></div>
            <label style="margin-top:8px">–ñ–µ–ª–∞–µ–º–æ–µ –∏–º—è (–ª–∞—Ç–∏–Ω—Å–∫–∏–º–∏, –±–µ–∑ —Ç–æ—á–∫–∏)</label>
            <input id="domainName" class="small" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: hay" />
            <div class="tiny" style="margin-top:6px">–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∞–¥—Ä–µ—Å –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ <code>hay.lumos</code> ‚Äî –≤ Lumos —ç—Ç–æ –æ—Ç–∫—Ä–æ–µ—Ç –º–∏–Ω–∏-—Å–∞–π—Ç.</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="btn-doCreate" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
              <button id="btn-cancelCreate" class="link-btn">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div id="createMsg" class="tiny" style="margin-top:8px;color:#b91c1c"></div>
          </div>

          <!-- site editor -->
          <div class="panel" id="panelEditor" style="display:none">
            <div><strong>–†–µ–¥–∞–∫—Ç–æ—Ä —Å–∞–π—Ç–∞</strong></div>
            <label style="margin-top:8px">–í—ã–±–µ—Ä–∏ —Å–≤–æ–π –ø–æ–¥–¥–æ–º–µ–Ω</label>
            <select id="selectMyDomains" class="small"></select>
            <label style="margin-top:8px">Title</label>
            <input id="siteTitle" class="small" />
            <label style="margin-top:8px">–û–ø–∏—Å–∞–Ω–∏–µ (description)</label>
            <input id="siteDesc" class="small" />
            <label style="margin-top:8px">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
            <input id="siteKeywords" class="small" />
            <label style="margin-top:8px">HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (index.html)</label>
            <textarea id="siteHtml" class="small"></textarea>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="btn-saveSite" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="btn-cancelEdit" class="link-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            <div id="editorMsg" class="tiny" style="margin-top:8px"></div>
          </div>

          <!-- my sites list -->
          <div class="panel" id="panelMySites" style="display:none">
            <div><strong>–ú–æ–∏ —Å–∞–π—Ç—ã</strong></div>
            <div id="mySitesList" style="margin-top:8px"></div>
            <div style="margin-top:8px"><button id="btn-closeMySites" class="link-btn">–ó–∞–∫—Ä—ã—Ç—å</button></div>
          </div>

          <div class="panel" id="panelBuy" >
            <div><strong>–ö—É–ø–∏—Ç—å –ø–æ–¥–¥–æ–º–µ–Ω</strong></div>
            <div class="tiny" style="margin-top:8px">–ü–æ–∫–∞ –≤ –ø—Ä–æ—Ç–æ—Ç–∏–ø–µ –ø–æ–∫—É–ø–∫–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã. –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–¥–¥–æ–º–µ–Ω—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –í –±—É–¥—É—â–µ–º —Ç—É—Ç –±—É–¥–µ—Ç –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç –∏–ª–∏ –ø–ª–∞—Ç—ë–∂–Ω—ã–π —à–ª—é–∑.</div>
          </div>
        </aside>
      </main>

      <div class="footer">–ú—ã —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ–º —Å DuckDuckGo –∏ –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏.</div>
    </div>
  </div>

  <!-- ========== Firebase + App logic ========== -->
  <script type="module">
  /************************************************************************
   * Lumos single-file app
   * - uses Firebase (Auth + Firestore)
   * - features:
   *   * login/register (email/password)
   *   * claim domain (stored in collection "domains")
   *   * edit site content (stored in domains.doc.siteHtml, title, description, keywords)
   *   * search internal domains and fallback to DuckDuckGo/Google/Bing
   *   * viewer via iframe srcdoc
   *
   * Notes:
   * - Admin email: alibahsburiev@gmail.com gets free creation rights.
   * - This prototype stores site HTML in Firestore (good for prototyping).
   * - To deploy to real filesystem (e.g. /sites/username/ on InfinityFree) you need server-side deployment or admin upload.
   **************************************************************************/

  // ---------- Firebase imports ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";

  // ---------- Your Firebase config (you provided) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCXPSk94YKKNIVOGnyhnDyuK8-KGPMZJog",
    authDomain: "lumos-f100f.firebaseapp.com",
    projectId: "lumos-f100f",
    storageBucket: "lumos-f100f.firebasestorage.app",
    messagingSenderId: "229952787613",
    appId: "1:229952787613:web:b173816977d0301d5ef074",
    measurementId: "G-13QWTHDGH7"
  };

  const app = initializeApp(firebaseConfig);
  // analytics optional
  try { const analytics = getAnalytics(app); } catch(e){ /* ignore if not available */ }

  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---------- DOM elements ----------
  const qInput = document.getElementById('q');
  const goBtn = document.getElementById('go');
  const statusEl = document.getElementById('status');
  const resultsWrap = document.getElementById('resultsWrap');
  const viewerWrap = document.getElementById('viewerWrap');
  const siteFrame = document.getElementById('siteFrame');
  const viewerTitle = document.getElementById('viewerTitle');
  const viewerMeta = document.getElementById('viewerMeta');

  const btnLogin = document.getElementById('btn-login');
  const btnLogout = document.getElementById('btn-logout');
  const btnRegister = document.getElementById('btn-register');
  const btnSignin = document.getElementById('btn-signin');

  const emailInput = document.getElementById('email');
  const passInput = document.getElementById('password');
  const userEmailLabel = document.getElementById('userEmail');
  const loggedOutPanel = document.getElementById('loggedOut');
  const loggedInPanel = document.getElementById('loggedIn');

  const panelCreate = document.getElementById('panelCreate');
  const btnCreateDomain = document.getElementById('btn-createDomain');
  const domainNameInput = document.getElementById('domainName');
  const btnDoCreate = document.getElementById('btn-doCreate');
  const btnCancelCreate = document.getElementById('btn-cancelCreate');
  const createMsg = document.getElementById('createMsg');

  const panelEditor = document.getElementById('panelEditor');
  const btnEditSite = document.getElementById('btn-editSite');
  const selectMyDomains = document.getElementById('selectMyDomains');
  const siteTitle = document.getElementById('siteTitle');
  const siteDesc = document.getElementById('siteDesc');
  const siteKeywords = document.getElementById('siteKeywords');
  const siteHtml = document.getElementById('siteHtml');
  const btnSaveSite = document.getElementById('btn-saveSite');
  const btnCancelEdit = document.getElementById('btn-cancelEdit');
  const editorMsg = document.getElementById('editorMsg');

  const panelMySites = document.getElementById('panelMySites');
  const btnMySites = document.getElementById('btn-mySites');
  const mySitesList = document.getElementById('mySitesList');
  const btnCloseMySites = document.getElementById('btn-closeMySites');

  const btnLogoutTop = document.getElementById('btn-logout');

  // helpers
  const ADMIN_EMAIL = 'alibahsburiev@gmail.com';

  function showStatus(s){ statusEl.textContent = s; }

  // ---------- Auth handlers ----------
  btnRegister.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const pass = passInput.value;
    if(!email || !pass || pass.length < 6){ alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –ø–æ—á—Ç—É –∏ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤).'); return; }
    try {
      await createUserWithEmailAndPassword(auth, email, pass);
      alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ ‚Äî –≤—ã –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É.');
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + err.message);
    }
  });

  btnSignin.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const pass = passInput.value;
    if(!email || !pass){ alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å.'); return; }
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω.');
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + err.message);
    }
  });

  btnLogout.addEventListener('click', async () => {
    await signOut(auth);
  });

  // update UI on auth change
  onAuthStateChanged(auth, async (user) => {
    if(user){
      userEmailLabel.textContent = user.email;
      loggedOutPanel.style.display = 'none';
      loggedInPanel.style.display = 'block';
      btnLogin.style.display = 'none';
      btnLogout.style.display = 'inline-block';
      userEmailLabel.style.display = 'inline-block';
      // populate user's domains in editor select
      await loadMyDomainsToSelect(user.uid);
    } else {
      userEmailLabel.textContent = '';
      loggedOutPanel.style.display = 'block';
      loggedInPanel.style.display = 'none';
      btnLogin.style.display = 'inline-block';
      btnLogout.style.display = 'none';
      selectMyDomains.innerHTML = '';
    }
  });

  // open login/register panel
  btnLogin.addEventListener('click', () => {
    window.scrollTo({top:0, behavior:'smooth'});
    emailInput.focus();
  });

  // ---------- Domain creation logic ----------
  btnCreateDomain.addEventListener('click', () => {
    panelCreate.style.display = 'block';
  });
  btnCancelCreate.addEventListener('click', () => {
    panelCreate.style.display = 'none';
    createMsg.textContent = '';
  });

  btnDoCreate.addEventListener('click', async () => {
    createMsg.textContent = '';
    const desired = (domainNameInput.value || '').trim().toLowerCase();
    if(!desired.match(/^[a-z0-9\-]{2,30}$/)){
      createMsg.textContent = '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 2‚Äì30 —Å–∏–º–≤–æ–ª–æ–≤: –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏–ª–∏ –¥–µ—Ñ–∏—Å.';
      return;
    }
    const user = auth.currentUser;
    if(!user){ createMsg.textContent = '–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–¥–æ–º–µ–Ω–∞.'; return; }

    const domainRef = doc(db, 'domains', desired);
    const snap = await getDoc(domainRef);
    if(snap.exists()){
      createMsg.textContent = '–≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ.';
      return;
    }

    // Admin bypass: admin can create free
    const isAdmin = (user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase());

    // For prototype: no payment integration ‚Äî admin free, others free too for now.
    // In production, check payment here (via Telegram bot / payment gateway).
    try {
      await setDoc(domainRef, {
        ownerUid: user.uid,
        ownerEmail: user.email || null,
        createdAt: serverTimestamp(),
        title: desired,
        description: `–°–∞–π—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${desired} –Ω–∞ Lumos`,
        keywords: [desired],
        siteHtml: `<html><head><meta charset="utf-8"><title>${escapeHtmlPlain(desired)}</title></head><body><h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ ${escapeHtmlPlain(desired)}.lumos</h1><p>–≠—Ç–æ –º–∏–Ω–∏-—Å–∞–π—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –≤ Lumos.</p></body></html>`
      });
      createMsg.style.color = 'green';
      createMsg.textContent = `–ü–æ–¥–¥–æ–º–µ–Ω "${desired}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`;
      domainNameInput.value = '';
      panelCreate.style.display = 'none';
      await loadMyDomainsToSelect(user.uid); // refresh user's list
    } catch (err) {
      createMsg.style.color = '#b91c1c';
      createMsg.textContent = '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + err.message;
    }
  });

  // ---------- Editor logic ----------
  btnEditSite.addEventListener('click', async () => {
    const user = auth.currentUser;
    if(!user){ alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∞–π—Ç—ã.'); return; }
    await loadMyDomainsToSelect(user.uid);
    panelEditor.style.display = 'block';
  });
  btnCancelEdit.addEventListener('click', ()=> { panelEditor.style.display = 'none'; editorMsg.textContent = ''; });

  selectMyDomains.addEventListener('change', async () => {
    const name = selectMyDomains.value;
    if(!name) return;
    const snap = await getDoc(doc(db, 'domains', name));
    if(!snap.exists()){ editorMsg.textContent = '–î–æ–∫—É–º–µ–Ω—Ç –ø–æ—Ç–µ—Ä—è–Ω.'; return; }
    const data = snap.data();
    siteTitle.value = data.title || '';
    siteDesc.value = data.description || '';
    siteKeywords.value = (Array.isArray(data.keywords)? data.keywords.join(',') : (data.keywords||''));
    siteHtml.value = data.siteHtml || (`<h1>${escapeHtmlPlain(name)}</h1><p>–í–∞—à —Å–∞–π—Ç –≤ Lumos</p>`);
    editorMsg.textContent = '';
  });

  btnSaveSite.addEventListener('click', async () => {
    const user = auth.currentUser;
    if(!user){ editorMsg.textContent = '–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏.'; return; }
    const name = selectMyDomains.value;
    if(!name){ editorMsg.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–¥–æ–º–µ–Ω.'; return; }

    // verify ownership
    const domainRef = doc(db, 'domains', name);
    const snap = await getDoc(domainRef);
    if(!snap.exists()){ editorMsg.textContent = '–î–æ–º–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.'; return; }
    const info = snap.data();
    if(info.ownerUid !== user.uid && (user.email !== ADMIN_EMAIL)) {
      editorMsg.textContent = '–í—ã –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü —ç—Ç–æ–≥–æ –ø–æ–¥–¥–æ–º–µ–Ω–∞.';
      return;
    }

    try {
      const keywordsArr = siteKeywords.value.split(',').map(s=>s.trim()).filter(Boolean);
      await updateDoc(domainRef, {
        title: siteTitle.value || name,
        description: siteDesc.value || '',
        keywords: keywordsArr,
        siteHtml: siteHtml.value || '',
        updatedAt: serverTimestamp()
      });
      editorMsg.style.color = 'green';
      editorMsg.textContent = '–°–∞–π—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω.';
    } catch (err) {
      editorMsg.style.color = '#b91c1c';
      editorMsg.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message;
    }
  });

  // ---------- My sites list ----------
  btnMySites.addEventListener('click', async () => {
    const user = auth.currentUser;
    if(!user){ alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ —Å–∞–π—Ç—ã.'); return; }
    panelMySites.style.display = 'block';
    mySitesList.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    const q = await getDocs(collection(db, 'domains'));
    const arr = [];
    q.forEach(d => {
      const val = d.data();
      if(val.ownerUid === user.uid) arr.push({id:d.id, ...val});
    });
    if(arr.length === 0) mySitesList.innerHTML = '<div class="tiny">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–∞–π—Ç–æ–≤.</div>';
    else {
      mySitesList.innerHTML = '';
      arr.forEach(s => {
        const div = document.createElement('div');
        div.style.padding = '8px 0';
        div.innerHTML = `<div style="font-weight:700">${escapeHtmlPlain(s.id)}.lumos</div>
                         <div class="tiny">${escapeHtmlPlain(s.description||'')}</div>
                         <div style="margin-top:6px"><a class="link-btn" href="#" data-go="${escapeHtmlPlain(s.id)}">–û—Ç–∫—Ä—ã—Ç—å</a></div>`;
        mySitesList.appendChild(div);
      });
      // add click handlers
      mySitesList.querySelectorAll('a[data-go]').forEach(a=>{
        a.addEventListener('click', (e)=>{
          e.preventDefault(); const nm = a.getAttribute('data-go'); renderSite(nm);
        });
      });
    }
  });
  btnCloseMySites.addEventListener('click', ()=> panelMySites.style.display = 'none');

  // ---------- Search logic ----------
  goBtn.addEventListener('click', ()=> doSearch(qInput.value));
  qInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') doSearch(qInput.value); });

  async function doSearch(raw){
    const q = (raw||'').trim();
    if(!q){ showStatus('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.'); return; }
    showStatus('–ò—â–µ–º: ' + q);
    resultsWrap.innerHTML = ''; viewerWrap.style.display = 'none';

    // If user typed something like "hay.lumos" -> try redirect to internal site
    if(q.toLowerCase().endsWith('.lumos')){
      const name = q.slice(0, -6).toLowerCase();
      if(!name.match(/^[a-z0-9\-]+$/)){ resultsWrap.innerHTML = `<div class="result-item">–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è: ${escapeHtmlPlain(q)}</div>`; return; }
      const snap = await getDoc(doc(db, 'domains', name));
      if(snap.exists()){
        renderSite(name);
        showStatus('–û—Ç–∫—Ä—ã–≤–∞–µ–º ' + name + '.lumos');
        return;
      } else {
        resultsWrap.innerHTML = `<div class="result-item"><div class="result-title">–°–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div><div class="result-desc">–ü–æ–¥–¥–æ–º–µ–Ω ${escapeHtmlPlain(name)} –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ Lumos.</div></div>`;
        return;
      }
    }

    // Otherwise: search internal DB (basic client-side filtering) + show external search links
    resultsWrap.innerHTML = `<div class="result-item">–ò–¥—ë—Ç –ø–æ–∏—Å–∫ –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –±–∞–∑–µ Lumos...</div>`;
    try {
      const snap = await getDocs(collection(db, 'domains'));
      const qlower = q.toLowerCase();
      const matches = [];
      snap.forEach(d => {
        const data = d.data();
        const title = (data.title||'').toString();
        const desc = (data.description||'').toString();
        const keys = (Array.isArray(data.keywords)? data.keywords.join(' ') : (data.keywords||'')).toString();
        const hay = (title + ' ' + desc + ' ' + keys + ' ' + d.id).toLowerCase();
        if(hay.indexOf(qlower) !== -1) matches.push({id:d.id, ...data});
      });

      // Build results
      resultsWrap.innerHTML = '';
      if(matches.length){
        const header = document.createElement('div'); header.className='result-item'; header.innerHTML = `<div class="result-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ Lumos</div><div class="result-desc tiny">${matches.length} –Ω–∞–π–¥–µ–Ω–æ</div>`;
        resultsWrap.appendChild(header);
        matches.forEach(m=>{
          const el = document.createElement('div'); el.className='result-item';
          el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                              <div class="result-title">${escapeHtmlPlain(m.title || m.id + '.lumos')}</div>
                              <div class="result-desc">${escapeHtmlPlain(m.description || '')}</div>
                            </div>
                            <div><a class="link-btn" href="#" data-open="${escapeHtmlPlain(m.id)}">–û—Ç–∫—Ä—ã—Ç—å</a></div>
                          </div>`;
          resultsWrap.appendChild(el);
        });
        // attach open handlers
        resultsWrap.querySelectorAll('a[data-open]').forEach(a=>{
          a.addEventListener('click', (e)=>{
            e.preventDefault(); const nm = a.getAttribute('data-open'); renderSite(nm);
          });
        });
      } else {
        resultsWrap.innerHTML = `<div class="result-item"><div class="result-title">–í–Ω—É—Ç—Ä–∏ Lumos –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div><div class="result-desc">–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–∏—Å–∫–æ–≤–∏–∫–æ–≤</div></div>`;
      }

      // External search fallback links
      const qEnc = encodeURIComponent(q);
      const ext = document.createElement('div'); ext.className = 'result-item';
      ext.innerHTML = `<div class="result-title">–í–Ω–µ—à–Ω–∏–π –ø–æ–∏—Å–∫</div>
                       <div style="margin-top:8px" class="links">
                         <a class="link-btn" target="_blank" rel="noopener" href="https://duckduckgo.com/?q=${qEnc}">DuckDuckGo</a>
                         <a class="link-btn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${qEnc}">Google</a>
                         <a class="link-btn" target="_blank" rel="noopener" href="https://www.bing.com/search?q=${qEnc}">Bing</a>
                       </div>`;
      resultsWrap.appendChild(ext);
      showStatus('–ì–æ—Ç–æ–≤–æ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫–∞–∑–∞–Ω—ã.');
    } catch (err) {
      resultsWrap.innerHTML = `<div class="result-item">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${escapeHtmlPlain(err.message)}</div>`;
      showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ');
    }
  }

  // ---------- render site in viewer ----------
  async function renderSite(name){
    viewerWrap.style.display = 'block';
    resultsWrap.innerHTML = '';
    showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∞–π—Ç–∞ ' + name + '.lumos ...');
    try {
      const snap = await getDoc(doc(db, 'domains', name));
      if(!snap.exists()){ resultsWrap.innerHTML = `<div class="result-item">–°–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>`; viewerWrap.style.display = 'none'; return; }
      const data = snap.data();
      viewerTitle.textContent = (data.title || name + '.lumos');
      viewerMeta.textContent = (data.ownerEmail? data.ownerEmail : '');
      const html = data.siteHtml || `<h1>${escapeHtmlPlain(name)}</h1><p>–ü—É—Å—Ç–æ–π —Å–∞–π—Ç.</p>`;
      // render into iframe via srcdoc (sandboxed)
      siteFrame.srcdoc = html;
      // set hash for shareable link
      location.hash = 'site=' + encodeURIComponent(name);
      showStatus('–°–∞–π—Ç –∑–∞–≥—Ä—É–∂–µ–Ω: ' + name + '.lumos');
    } catch (err) {
      showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message);
      resultsWrap.innerHTML = `<div class="result-item">–û—à–∏–±–∫–∞: ${escapeHtmlPlain(err.message)}</div>`;
    }
  }

  // On load: if hash like #site=name -> open it
  window.addEventListener('load', ()=>{
    const h = location.hash;
    if(h && h.startsWith('#site=')){
      const name = decodeURIComponent(h.slice(6));
      if(name) renderSite(name);
    }
  });

  // ---------- Utilities ----------
  function escapeHtmlPlain(s){
    if(!s) return '';
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }

  async function loadMyDomainsToSelect(uid){
    selectMyDomains.innerHTML = '';
    const q = await getDocs(collection(db, 'domains'));
    const my = [];
    q.forEach(d=>{
      const data = d.data();
      if(data.ownerUid === uid) my.push(d.id);
    });
    if(my.length === 0){
      selectMyDomains.innerHTML = '<option value="">–£ –≤–∞—Å –Ω–µ—Ç —Å–∞–π—Ç–æ–≤</option>';
    } else {
      selectMyDomains.innerHTML = '<option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ --</option>' + my.map(n=>`<option value="${escapeHtmlPlain(n)}">${escapeHtmlPlain(n)}.lumos</option>`).join('');
    }
  }

  // small helper: update list on sign in/out
  // Already handled in onAuthStateChanged

  // ---------- small XSS caution note to admin in console ----------
  console.info('Lumos prototype loaded. Note: site HTML is stored in Firestore (siteHtml). Viewer uses iframe.srcdoc (sandboxed allow-scripts).');

  // triple-checked logical flows: registration -> domain creation -> edit -> search -> viewer
  // End of module
  </script>
</body>
</html>
